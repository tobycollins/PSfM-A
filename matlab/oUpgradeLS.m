function [Xs,Ws] = oUpgradeLS(As)

M=size(As,3);
B = zeros(M,4);
for i=1:M
    Ma = As(:,:,i);
    E = Ma'*Ma;
    B(i,1) = E(1,1);
    B(i,2) = 2*E(1,2);
    B(i,3) = E(2,2);
    B(i,4) = -det(E);
end

H = B'*B;
F = [0,0,-1;0,2,0;-1,0,0];

%[Q,L] = ql(H);
H_ = H([end:-1:1],:);
H_ = H_(:,[end:-1:1]);
[Q,L] = qr(H_);
Q = Q([end:-1:1],:);
Q = Q(:,[end:-1:1]);
L = L([end:-1:1],:);
L = L(:,[end:-1:1]);


P = - (Q(:,1:3))'*B'*ones(M,1);
C = Q(4,1:3)'*1;

Q33TF = Q(1:3,1:3)'*F;
L33 = L(1:3,1:3);
BTb = B'*ones(M,1);
a = BTb(4);
h = H(4,:);


L11 = L33(1,1);
L12 = L33(1,2);
L13 = L33(1,3);

L21 = L33(2,1);
L22 = L33(2,2);
L23 = L33(2,3);

L31 = L33(3,1);
L32 = L33(3,2);
L33 = L33(3,3);


K11 = Q33TF(1,1);
K12 = Q33TF(1,2);
K13 = Q33TF(1,3);

K21 = Q33TF(2,1);
K22 = Q33TF(2,2);
K23 = Q33TF(2,3);

K31 = Q33TF(3,1);
K32 = Q33TF(3,2);
K33 = Q33TF(3,3);

h1 = h(1);
h2 = h(2);
h3 = h(3);
h4 = h(4);
C1 = C(1);
C2 = C(2);
C3 = C(3);
P1 = P(1);
P2 = P(2);
P3 = P(3);



cc = computeUnivarCoeffs(C1,C2,C3,K11,K12,K13,K21,K22,K23,K31,K32,K33,L11,L12,L13,L21,L22,L23,L31,L32,L33,P1,P2,P3,a,h1,h2,h3,h4);

ss = roots(cc);
reals = abs(imag(ss))<1e-2;
ss = ss(reals);
ss = real(ss);


Xs = [];
Ws=[];
numSols = 0;

univarSols = [];
for i=1:length(ss)
    v_ = ss(i);
    A = (compAdj(L(1:3,1:3)+v_*Q33TF));
    w_ = A*(-P - v_*C)/det(L(1:3,1:3)+v_*Q33TF);
    W = [w_(1),w_(2);w_(2),w_(3)];
    try
        [X] = (chol(W,'lower'));
        numSols = numSols+1;
        Xs(:,:,numSols) = X;
        Ws(:,:,numSols) = W;
        univarSols(numSols) = v_;
    catch
        continue;
    end
    
end
localMins= false(1,numSols);
for ii=1:numSols
    W = Ws(:,:,ii);
    
    localMins(ii) = testLocalMin(B,W);
    
end
kp = localMins;
Xs = Xs(:,:,kp);
Ws = Ws(:,:,kp);
univarSols = univarSols(kp);


function localMin = testLocalMin(B,W)


BTB = B'*B;
b = ones(size(B,1),1);
D = BTB;
E = - 2*b'*B;
f =  b'*b;

D11 = D(1,1);
D12 = D(1,2);
D13 = D(1,3);
D14 = D(1,4);

D21 = D(2,1);
D22 = D(2,2);
D23 = D(2,3);
D24 = D(2,4);

D31 = D(3,1);
D32 = D(3,2);
D33 = D(3,3);
D34 = D(3,4);

D41 = D(4,1);
D42 = D(4,2);
D43 = D(4,3);
D44 = D(4,4);

E1 = E(1);
E2 = E(2);
E3 = E(3);
E4 = E(4);

w1 = W(1,1);
w2 = W(1,2);
w3 = W(2,2);


J =  [E1 + (D14 + D44*w3)*(- w2^2 + w1*w3) + w3*(D14*w1 + D24*w2 + D34*w3 + D44*(- w2^2 + w1*w3)) + D11*w1 + D21*w2 + D31*w3 + E4*w3 + D41*(- w2^2 + w1*w3) + w1*(D11 + D41*w3) + w2*(D12 + D42*w3) + w3*(D13 + D43*w3);
    E2 + (D24 - 2*D44*w2)*(- w2^2 + w1*w3) - 2*w2*(D14*w1 + D24*w2 + D34*w3 + D44*(- w2^2 + w1*w3)) + D12*w1 + D22*w2 + D32*w3 - 2*E4*w2 + D42*(- w2^2 + w1*w3) + w1*(D21 - 2*D41*w2) + w2*(D22 - 2*D42*w2) + w3*(D23 - 2*D43*w2);
    E3 + (D34 + D44*w1)*(- w2^2 + w1*w3) + w1*(D14*w1 + D24*w2 + D34*w3 + D44*(- w2^2 + w1*w3)) + D13*w1 + D23*w2 + D33*w3 + E4*w1 + D43*(- w2^2 + w1*w3) + w1*(D31 + D41*w1) + w2*(D32 + D42*w1) + w3*(D33 + D43*w1)];

H = [                                                                                                    2*D11 + 2*D41*w3 + 2*w3*(D14 + D44*w3),                                                       D12 + D21 - 2*D41*w2 + D42*w3 - 2*w2*(D14 + D44*w3) + w3*(D24 - 2*D44*w2), D13 + D31 + E4 + D14*w1 + D24*w2 + D34*w3 + 2*D41*w1 + D42*w2 + 2*D43*w3 + 2*D44*(- w2^2 + w1*w3) + w1*(D14 + D44*w3) + w3*(D34 + D44*w1);
    D12 + D21 - 2*D41*w2 + D42*w3 - 2*w2*(D14 + D44*w3) + w3*(D24 - 2*D44*w2), 2*D22 - 2*E4 - 2*D14*w1 - 2*D24*w2 - 2*D34*w3 - 2*D41*w1 - 6*D42*w2 - 2*D43*w3 - 4*D44*(- w2^2 + w1*w3) - 4*w2*(D24 - 2*D44*w2),                                                                 D23 + D32 + D42*w1 - 2*D43*w2 + w1*(D24 - 2*D44*w2) - 2*w2*(D34 + D44*w1);
    D13 + D31 + E4 + D14*w1 + D24*w2 + D34*w3 + 2*D41*w1 + D42*w2 + 2*D43*w3 + 2*D44*(- w2^2 + w1*w3) + w1*(D14 + D44*w3) + w3*(D34 + D44*w1),                                                       D23 + D32 + D42*w1 - 2*D43*w2 + w1*(D24 - 2*D44*w2) - 2*w2*(D34 + D44*w1),                                                                                                    2*D33 + 2*D43*w1 + 2*w1*(D34 + D44*w1)];


[V,D] = eig(H);
pvs = sum(diag(D)>-1e-6);
switch pvs
    case 0
        localMin = 0;
    case 1
        localMin = 0;
        
    case 2
        localMin = 0;
        
    case 3
        localMin = 1;
        
        
end

return;


function A = compAdj(X)


X11 = X(1,1);
X12 = X(1,2);
X13 = X(1,3);

X21 = X(2,1);
X22 = X(2,2);
X23 = X(2,3);

X31 = X(3,1);
X32 = X(3,2);
X33 = X(3,3);




A = [X22*X33 - X23*X32, X13*X32 - X12*X33, X12*X23 - X13*X22;...
    X23*X31 - X21*X33, X11*X33 - X13*X31, X13*X21 - X11*X23;...
    X21*X32 - X22*X31, X12*X31 - X11*X32, X11*X22 - X12*X21];













function cc = computeUnivarCoeffs(C1,C2,C3,K11,K12,K13,K21,K22,K23,K31,K32,K33,L11,L12,L13,L21,L22,L23,L31,L32,L33,P1,P2,P3,a,h1,h2,h3,h4)


t3 = K11.*K22.*K33;
t4 = K11.*K23.*K32;
t5 = K12.*K21.*K33;
t6 = K12.*K23.*K31;
t7 = K13.*K21.*K32;
t8 = K13.*K22.*K31;
t2 = t3-t4-t5+t6+t7-t8;
t9 = t2.^2;
t20 = K11.*K23;
t21 = K13.*K21;
t22 = t20-t21;
t23 = C3.*t22;
t24 = K11.*K33;
t25 = K13.*K31;
t26 = t24-t25;
t27 = C2.*t26;
t28 = K21.*K33;
t29 = K23.*K31;
t30 = t28-t29;
t31 = C1.*t30;
t10 = t23-t27+t31;
t11 = K11.*K22;
t49 = K12.*K21;
t12 = t11-t49;
t13 = C3.*t12;
t14 = K11.*K32;
t50 = K12.*K31;
t15 = t14-t50;
t16 = K21.*K32;
t51 = K22.*K31;
t17 = t16-t51;
t18 = C1.*t17;
t52 = C2.*t15;
t19 = t13+t18-t52;
t32 = K12.*K23;
t45 = K13.*K22;
t33 = t32-t45;
t34 = C3.*t33;
t35 = K12.*K33;
t46 = K13.*K32;
t36 = t35-t46;
t37 = K22.*K33;
t48 = K23.*K32;
t38 = t37-t48;
t39 = C1.*t38;
t47 = C2.*t36;
t40 = t34+t39-t47;
t41 = K11.*K22.*K33.*2.0;
t42 = K12.*K23.*K31.*2.0;
t43 = K13.*K21.*K32.*2.0;
t141 = K11.*K23.*K32.*2.0;
t142 = K12.*K21.*K33.*2.0;
t143 = K13.*K22.*K31.*2.0;
t44 = t41+t42+t43-t141-t142-t143;
t53 = K11.*K22.*L33;
t54 = K11.*K33.*L22;
t55 = K12.*K23.*L31;
t56 = K12.*K31.*L23;
t57 = K13.*K21.*L32;
t58 = K13.*K32.*L21;
t59 = K21.*K32.*L13;
t60 = K22.*K33.*L11;
t61 = K23.*K31.*L12;
t105 = K11.*K23.*L32;
t106 = K11.*K32.*L23;
t107 = K12.*K21.*L33;
t108 = K12.*K33.*L21;
t109 = K13.*K22.*L31;
t110 = K13.*K31.*L22;
t111 = K21.*K33.*L12;
t112 = K22.*K31.*L13;
t113 = K23.*K32.*L11;
t62 = t53+t54+t55+t56+t57+t58+t59+t60+t61-t105-t106-t107-t108-t109-t110-t111-t112-t113;
t63 = K11.*L22;
t64 = K22.*L11;
t114 = K12.*L21;
t115 = K21.*L12;
t65 = t63+t64-t114-t115;
t66 = C3.*t65;
t67 = K11.*L32;
t68 = K32.*L11;
t116 = K12.*L31;
t117 = K31.*L12;
t69 = t67+t68-t116-t117;
t70 = K21.*L32;
t71 = K32.*L21;
t119 = K22.*L31;
t120 = K31.*L22;
t72 = t70+t71-t119-t120;
t73 = C1.*t72;
t74 = P3.*t12;
t75 = P1.*t17;
t118 = C2.*t69;
t121 = P2.*t15;
t76 = t66+t73+t74+t75-t118-t121;
t77 = K11.*L23;
t78 = K23.*L11;
t130 = K13.*L21;
t131 = K21.*L13;
t79 = t77+t78-t130-t131;
t80 = C3.*t79;
t81 = K11.*L33;
t82 = K33.*L11;
t132 = K13.*L31;
t133 = K31.*L13;
t83 = t81+t82-t132-t133;
t84 = K21.*L33;
t85 = K33.*L21;
t135 = K23.*L31;
t136 = K31.*L23;
t86 = t84+t85-t135-t136;
t87 = C1.*t86;
t88 = P3.*t22;
t89 = P1.*t30;
t134 = C2.*t83;
t137 = P2.*t26;
t90 = t80+t87+t88+t89-t134-t137;
t91 = K12.*L23;
t92 = K23.*L12;
t122 = K13.*L22;
t123 = K22.*L13;
t93 = t91+t92-t122-t123;
t94 = C3.*t93;
t95 = K12.*L33;
t96 = K33.*L12;
t124 = K13.*L32;
t125 = K32.*L13;
t97 = t95+t96-t124-t125;
t98 = K22.*L33;
t99 = K33.*L22;
t127 = K23.*L32;
t128 = K32.*L23;
t100 = t98+t99-t127-t128;
t101 = C1.*t100;
t102 = P3.*t33;
t103 = P1.*t38;
t126 = C2.*t97;
t129 = P2.*t36;
t104 = t94+t101+t102+t103-t126-t129;
t138 = C3.*t22.*2.0;
t139 = C1.*t30.*2.0;
t212 = C2.*t26.*2.0;
t140 = t138+t139-t212;
t144 = K11.*L22.*L33;
t145 = K12.*L23.*L31;
t146 = K13.*L21.*L32;
t147 = K21.*L13.*L32;
t148 = K22.*L11.*L33;
t149 = K23.*L12.*L31;
t150 = K31.*L12.*L23;
t151 = K32.*L13.*L21;
t152 = K33.*L11.*L22;
t188 = K11.*L23.*L32;
t189 = K12.*L21.*L33;
t190 = K13.*L22.*L31;
t191 = K21.*L12.*L33;
t192 = K22.*L13.*L31;
t193 = K23.*L11.*L32;
t194 = K31.*L13.*L22;
t195 = K32.*L11.*L23;
t196 = K33.*L12.*L21;
t153 = t144+t145+t146+t147+t148+t149+t150+t151+t152-t188-t189-t190-t191-t192-t193-t194-t195-t196;
t154 = t62.^2;
t155 = P3.*t65;
t156 = P1.*t72;
t157 = L11.*L22;
t203 = L12.*L21;
t158 = t157-t203;
t159 = C3.*t158;
t160 = L11.*L32;
t204 = L12.*L31;
t161 = t160-t204;
t162 = L21.*L32;
t206 = L22.*L31;
t163 = t162-t206;
t164 = C1.*t163;
t202 = P2.*t69;
t205 = C2.*t161;
t165 = t155+t156+t159+t164-t202-t205;
t166 = P3.*t79;
t167 = P1.*t86;
t168 = L11.*L23;
t208 = L13.*L21;
t169 = t168-t208;
t170 = C3.*t169;
t171 = L11.*L33;
t209 = L13.*L31;
t172 = t171-t209;
t173 = L21.*L33;
t211 = L23.*L31;
t174 = t173-t211;
t175 = C1.*t174;
t207 = P2.*t83;
t210 = C2.*t172;
t176 = t166+t167+t170+t175-t207-t210;
t177 = P3.*t93;
t178 = P1.*t100;
t179 = L12.*L23;
t198 = L13.*L22;
t180 = t179-t198;
t181 = C3.*t180;
t182 = L12.*L33;
t199 = L13.*L32;
t183 = t182-t199;
t184 = L22.*L33;
t201 = L23.*L32;
t185 = t184-t201;
t186 = C1.*t185;
t197 = P2.*t97;
t200 = C2.*t183;
t187 = t177+t178+t181+t186-t197-t200;
t213 = L11.*L22.*L33;
t214 = L12.*L23.*L31;
t215 = L13.*L21.*L32;
t236 = L11.*L23.*L32;
t237 = L12.*L21.*L33;
t238 = L13.*L22.*L31;
t216 = t213+t214+t215-t236-t237-t238;
t217 = K11.*L22.*L33.*2.0;
t218 = K12.*L23.*L31.*2.0;
t219 = K13.*L21.*L32.*2.0;
t220 = K21.*L13.*L32.*2.0;
t221 = K22.*L11.*L33.*2.0;
t222 = K23.*L12.*L31.*2.0;
t223 = K31.*L12.*L23.*2.0;
t224 = K32.*L13.*L21.*2.0;
t225 = K33.*L11.*L22.*2.0;
t226 = t217+t218+t219+t220+t221+t222+t223+t224+t225-K11.*L23.*L32.*2.0-K12.*L21.*L33.*2.0-K13.*L22.*L31.*2.0-K21.*L12.*L33.*2.0-K22.*L13.*L31.*2.0-K23.*L11.*L32.*2.0-K31.*L13.*L22.*2.0-K32.*L11.*L23.*2.0-K33.*L12.*L21.*2.0;
t227 = P3.*t158;
t228 = P1.*t163;
t244 = P2.*t161;
t229 = t227+t228-t244;
t230 = P3.*t169;
t231 = P1.*t174;
t249 = P2.*t172;
t232 = t230+t231-t249;
t233 = P3.*t180;
t234 = P1.*t185;
t243 = P2.*t183;
t235 = t233+t234-t243;
t239 = L11.*L22.*L33.*2.0;
t240 = L12.*L23.*L31.*2.0;
t241 = L13.*L21.*L32.*2.0;
t245 = L11.*L23.*L32.*2.0;
t246 = L12.*L21.*L33.*2.0;
t247 = L13.*L22.*L31.*2.0;
t242 = t239+t240+t241-t245-t246-t247;
t248 = t153.^2;
t250 = P3.*t169.*2.0;
t251 = P1.*t174.*2.0;
t252 = t250+t251-P2.*t172.*2.0;
t253 = t216.^2;
cc = [-t9,a.*t9-t44.*t62-h4.*(t19.*t40-t10.^2)-h2.*t2.*t10+h3.*t2.*t19+h1.*t2.*t40,-t154-t44.*t153-h4.*(t40.*t76+t19.*t104-t90.*t140)+a.*t2.*t62.*2.0-h2.*t10.*t62+h3.*t2.*t76+h3.*t19.*t62-h2.*t2.*t90+h1.*t40.*t62+h1.*t2.*t104,-t44.*t216-t62.*t226-h4.*(t76.*t104+t40.*t165+t19.*t187-t140.*t176-t90.^2)+a.*(t154+t44.*t153)+h3.*t62.*t76-h2.*t62.*t90-h2.*t10.*t153+h1.*t62.*t104+h3.*t2.*t165+h3.*t19.*t153-h2.*t2.*t176+h1.*t2.*t187+h1.*t40.*t153,-t248-t62.*t242-h4.*(t19.*t235+t76.*t187+t40.*t229+t104.*t165-t140.*t232-t176.*(C3.*t79.*2.0-C2.*t83.*2.0+C1.*t86.*2.0+P3.*t22.*2.0-P2.*t26.*2.0+P1.*t30.*2.0))+a.*(t44.*t216+t62.*t226)-h2.*t10.*t216+h3.*t62.*t165+h3.*t76.*t153+h3.*t2.*t229-h2.*t2.*t232+h1.*t2.*t235+h3.*t19.*t216-h2.*t62.*t176-h2.*t90.*t153+h1.*t62.*t187+h1.*t40.*t216+h1.*t104.*t153,-t153.*t242-h4.*(t76.*t235+t104.*t229-t90.*t252+t165.*t187-t176.^2)+a.*(t248+t62.*t242)+h3.*t62.*t229+h3.*t76.*t216-h2.*t62.*t232+h1.*t62.*t235-h2.*t90.*t216+h1.*t104.*t216+h3.*t153.*t165-h2.*t153.*t176+h1.*t153.*t187,-t253-h4.*(t165.*t235+t187.*t229-t176.*t252)+a.*t153.*t216.*2.0+h3.*t165.*t216+h3.*t153.*t229-h2.*t153.*t232+h1.*t153.*t235-h2.*t176.*t216+h1.*t187.*t216,a.*t253-h4.*(t229.*t235-t232.^2)+h3.*t216.*t229-h2.*t216.*t232+h1.*t216.*t235];



